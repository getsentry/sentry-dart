name: Kotlin Version Compatibility

on:
  push:
    branches:
      - main
      - release/**
  pull_request:
    paths:
      - ".github/workflows/kotlin-version-compatibility.yml"
      - "packages/flutter/android/**"
      - "packages/flutter/example/android/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build-apk-kotlin-versions:
    name: "APK | Kotlin lang ${{ matrix.kotlin_language_version }}"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: packages/flutter/example
    strategy:
      fail-fast: false
      matrix:
        kotlin_language_version: ["1.7", "2.0", "2.3"]

    env:
      KOTLIN_LANGUAGE_VERSION: ${{ matrix.kotlin_language_version }}

    steps:
      - uses: actions/checkout@v5

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # pin@v2.21.0
        with:
          channel: stable

      - name: Flutter pub get
        run: flutter pub get

      - name: Build APK with Kotlin language version ${{ matrix.kotlin_language_version }}
        run: flutter build apk --debug --target-platform=android-x64

      - name: Verify build artifacts
        run: |
          if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
            echo "APK build successful with Kotlin language version ${{ matrix.kotlin_language_version }}"
            ls -lh build/app/outputs/flutter-apk/app-debug.apk
          else
            echo "APK build failed - artifact not found"
            exit 1
          fi
