name: Size Analysis

on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  SENTRY_ORG: sentry-sdks
  SENTRY_PROJECT: sentry-flutter
  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

jobs:
  android:
    name: Android
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: packages/flutter/example

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v5
        with:
          distribution: 'adopt'
          java-version: '17'

      - name: Read configured Flutter SDK version
        id: conf
        run: |
          version=$(grep "version" ../../../metrics/flutter.properties | cut -d'=' -f2 | xargs)
          echo "flutter=$version" >> "$GITHUB_OUTPUT"

      - name: Install Flutter v${{ steps.conf.outputs.flutter }}
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # pin@v2.21.0
        with:
          flutter-version: ${{ steps.conf.outputs.flutter }}

      - name: Install Sentry CLI
        if: env.SENTRY_AUTH_TOKEN != ''
        run: curl -sL https://sentry.io/get-cli/ | SENTRY_CLI_VERSION=2.58.2 sh

      - name: Determine build version
        run: |
          version_line=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          # Remove any + suffix first (for pubspec.yaml versions like 1.2.3+4)
          version=${version_line%%+*}

          # Parse version: x.y.z-suffix.n → build_name=x.y.z, build_number=n
          # Supports: x.y.z, x.y.z-alpha.n, x.y.z-beta.n, x.y.z-rc.n, etc.
          # Note: build_name is x.y.z only (plist/Android compatibility)
          if [[ $version =~ ^([0-9]+\.[0-9]+\.[0-9]+)-[a-zA-Z]+\.([0-9]+)$ ]]; then
            build_name="${BASH_REMATCH[1]}"
            build_number="${BASH_REMATCH[2]}"
          elif [[ $version =~ ^([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            build_name="${BASH_REMATCH[1]}"
            build_number=1
          else
            build_name="$version"
            build_number=1
          fi

          echo "SIZE_VERSION=$build_name" >> "$GITHUB_ENV"
          echo "SIZE_BUILD=$build_number" >> "$GITHUB_ENV"

      - name: Get merge base SHA
        id: merge-base
        if: env.SENTRY_AUTH_TOKEN != ''
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA=$(git merge-base HEAD origin/main || echo "${{ github.event.before }}")
          fi
          echo "sha=$BASE_SHA" >> "$GITHUB_OUTPUT"

      - name: Build Android Appbundle
        run: |
          flutter pub get
          flutter build appbundle --release \
            --build-name "$SIZE_VERSION" \
            --build-number "$SIZE_BUILD"

      - name: Upload Android Bundle to Sentry Size Analysis
        if: env.SENTRY_AUTH_TOKEN != ''
        run: |
          UPLOAD_ARGS=(
            "build/app/outputs/bundle/release/app-release.aab"
            "--org" "${{ env.SENTRY_ORG }}"
            "--project" "${{ env.SENTRY_PROJECT }}"
            "--build-configuration" "Release"
            "--head-sha" "${{ github.event.pull_request.head.sha || github.sha }}"
            "--head-repo-name" "${{ github.repository }}"
            "--head-ref" "${{ github.head_ref || github.ref_name }}"
            "--base-ref" "${{ github.base_ref || 'main' }}"
          )

          if [ -n "${{ steps.merge-base.outputs.sha }}" ]; then
            UPLOAD_ARGS+=("--base-sha" "${{ steps.merge-base.outputs.sha }}")
          fi

          if [ -n "${{ github.event.pull_request.number }}" ]; then
            UPLOAD_ARGS+=("--pr-number" "${{ github.event.pull_request.number }}")
          fi

          sentry-cli build upload "${UPLOAD_ARGS[@]}"

  ios:
    name: iOS
    runs-on: macos-15
    timeout-minutes: 45
    defaults:
      run:
        working-directory: packages/flutter/example

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Read configured Flutter SDK version
        id: conf
        run: |
          version=$(grep "version" ../../../metrics/flutter.properties | cut -d'=' -f2 | xargs)
          echo "flutter=$version" >> "$GITHUB_OUTPUT"

      - name: Install Flutter v${{ steps.conf.outputs.flutter }}
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # pin@v2.21.0
        with:
          flutter-version: ${{ steps.conf.outputs.flutter }}

      - name: Install Sentry CLI
        if: env.SENTRY_AUTH_TOKEN != ''
        run: curl -sL https://sentry.io/get-cli/ | SENTRY_CLI_VERSION=2.58.2 sh

      - name: Determine build version
        run: |
          version_line=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          # Remove any + suffix first (for pubspec.yaml versions like 1.2.3+4)
          version=${version_line%%+*}

          # Parse version: x.y.z-suffix.n → build_name=x.y.z, build_number=n
          # Supports: x.y.z, x.y.z-alpha.n, x.y.z-beta.n, x.y.z-rc.n, etc.
          # Note: build_name is x.y.z only (plist/Android compatibility)
          if [[ $version =~ ^([0-9]+\.[0-9]+\.[0-9]+)-[a-zA-Z]+\.([0-9]+)$ ]]; then
            build_name="${BASH_REMATCH[1]}"
            build_number="${BASH_REMATCH[2]}"
          elif [[ $version =~ ^([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            build_name="${BASH_REMATCH[1]}"
            build_number=1
          else
            build_name="$version"
            build_number=1
          fi

          echo "SIZE_VERSION=$build_name" >> "$GITHUB_ENV"
          echo "SIZE_BUILD=$build_number" >> "$GITHUB_ENV"

      # QuickFix for failing iOS 18.0 builds https://github.com/actions/runner-images/issues/12758#issuecomment-3187115656
      - name: Switch to Xcode 16.4 for iOS 18.5
        run: sudo xcode-select --switch /Applications/Xcode_16.4.app

      - name: Build Flutter iOS
        run: |
          flutter pub get
          flutter build ipa --release --no-codesign \
            --build-name "$SIZE_VERSION" \
            --build-number "$SIZE_BUILD"

      - name: Get merge base SHA
        id: merge-base
        if: env.SENTRY_AUTH_TOKEN != ''
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA=$(git merge-base HEAD origin/main || echo "${{ github.event.before }}")
          fi
          echo "sha=$BASE_SHA" >> "$GITHUB_OUTPUT"

      - name: Upload iOS XCArchive to Sentry Size Analysis
        if: env.SENTRY_AUTH_TOKEN != ''
        run: |
          UPLOAD_ARGS=(
            "build/ios/archive/Runner.xcarchive"
            "--org" "${{ env.SENTRY_ORG }}"
            "--project" "${{ env.SENTRY_PROJECT }}"
            "--build-configuration" "Release"
            "--head-sha" "${{ github.event.pull_request.head.sha || github.sha }}"
            "--head-repo-name" "${{ github.repository }}"
            "--head-ref" "${{ github.head_ref || github.ref_name }}"
            "--base-ref" "${{ github.base_ref || 'main' }}"
          )

          if [ -n "${{ steps.merge-base.outputs.sha }}" ]; then
            UPLOAD_ARGS+=("--base-sha" "${{ steps.merge-base.outputs.sha }}")
          fi

          if [ -n "${{ github.event.pull_request.number }}" ]; then
            UPLOAD_ARGS+=("--pr-number" "${{ github.event.pull_request.number }}")
          fi

          sentry-cli build upload "${UPLOAD_ARGS[@]}"
